<UserControl x:Class="MES.Views.Machines"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:MES.Helpers"
             Height="700" Width="1200">
    
    <UserControl.Resources>
        <!-- Converters -->
        <local:StatusToColorConverter x:Key="StatusToColorConverter"/>
        <local:CountToVisibilityConverter x:Key="CountToVisibilityConverter"/>
        
        <!-- Status Color Converter -->
        <Style x:Key="StatusIndicatorStyle" TargetType="Ellipse">
            <Setter Property="Width" Value="12"/>
            <Setter Property="Height" Value="12"/>
            <Setter Property="Margin" Value="5,0"/>
        </Style>
        
        <!-- Status Colors -->
        <SolidColorBrush x:Key="IdleColor" Color="#CCCCCC"/>
        <SolidColorBrush x:Key="RunningColor" Color="#4CAF50"/>
        <SolidColorBrush x:Key="MaintenanceColor" Color="#FF9800"/>
        <SolidColorBrush x:Key="ErrorColor" Color="#F44336"/>
        
        <!-- Button Styles -->
        <Style x:Key="ActionButtonStyle" TargetType="Button">
            <Setter Property="Margin" Value="5"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="MinWidth" Value="80"/>
        </Style>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10" Background="#F5F5F5">
            <TextBlock Text="Quáº£n lÃ½ MÃ¡y mÃ³c" FontSize="24" FontWeight="Bold" Margin="10"/>
            <TextBlock Text="Há»‡ thá»‘ng MES" FontSize="16" VerticalAlignment="Center" Foreground="Gray" Margin="20,0"/>
        </StackPanel>
        
        <!-- Toolbar -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="10">
            <Button Content="âž• ThÃªm mÃ¡y" Command="{Binding AddMachineCommand}" Style="{StaticResource ActionButtonStyle}" Background="#4CAF50" Foreground="White"/>
            <Button Content="âœï¸ Sá»­a" Command="{Binding EditMachineCommand}" Style="{StaticResource ActionButtonStyle}" Background="#2196F3" Foreground="White"/>
            <Button Content="ðŸ—‘ï¸ XÃ³a" Command="{Binding DeleteMachineCommand}" Style="{StaticResource ActionButtonStyle}" Background="#F44336" Foreground="White"/>
            <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="10,0"/>
            <Button Content="ðŸ”„ Cáº­p nháº­t tráº¡ng thÃ¡i" Command="{Binding UpdateStatusCommand}" Style="{StaticResource ActionButtonStyle}" Background="#FF9800" Foreground="White"/>
            <Button Content="ðŸ”§ Báº£o trÃ¬" Command="{Binding AddMaintenanceCommand}" Style="{StaticResource ActionButtonStyle}" Background="#9C27B0" Foreground="White"/>
            <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="10,0"/>
            <Button Content="ðŸ”„ LÃ m má»›i" Command="{Binding RefreshCommand}" Style="{StaticResource ActionButtonStyle}" Background="#00BCD4" Foreground="White"/>
        </StackPanel>
        
        <!-- Search and Filter -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="10,0,10,10">
            <TextBlock Text="TÃ¬m kiáº¿m:" VerticalAlignment="Center" Margin="0,0,10,0"/>
            <TextBox Text="{Binding SearchTerm, UpdateSourceTrigger=PropertyChanged}" Width="200" Margin="0,0,20,0" 
                     ToolTip="Nháº­p tÃªn mÃ¡y hoáº·c loáº¡i mÃ¡y Ä‘á»ƒ tÃ¬m kiáº¿m"/>
            
            <TextBlock Text="Lá»c theo tráº¡ng thÃ¡i:" VerticalAlignment="Center" Margin="0,0,10,0"/>
            <ComboBox SelectedItem="{Binding SelectedStatus}" Width="150" Margin="0,0,20,0">
                <ComboBoxItem Content="Táº¥t cáº£"/>
                <ComboBoxItem Content="Idle"/>
                <ComboBoxItem Content="Running"/>
                <ComboBoxItem Content="Maintenance"/>
                <ComboBoxItem Content="Error"/>
            </ComboBox>
        </StackPanel>
        
        <!-- Main Content -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- Machines DataGrid -->
            <DataGrid Grid.Column="0" 
                      ItemsSource="{Binding Machines}" 
                      SelectedItem="{Binding SelectedMachine}"
                      AutoGenerateColumns="False" 
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      IsReadOnly="True"
                      GridLinesVisibility="All"
                      HeadersVisibility="All"
                      AlternatingRowBackground="#F9F9F9"
                      Margin="10">
                
                <DataGrid.Columns>
                    <DataGridTemplateColumn Header="Tráº¡ng thÃ¡i" Width="80">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Ellipse Style="{StaticResource StatusIndicatorStyle}"
                                         Fill="{Binding Status, Converter={StaticResource StatusToColorConverter}}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <DataGridTextColumn Header="ID" Binding="{Binding MachineId}" Width="60"/>
                    <DataGridTextColumn Header="TÃªn mÃ¡y" Binding="{Binding MachineName}" Width="200"/>
                    <DataGridTextColumn Header="Loáº¡i mÃ¡y" Binding="{Binding MachineType}" Width="150"/>
                    <DataGridTextColumn Header="Tráº¡ng thÃ¡i" Binding="{Binding Status}" Width="100"/>
                    <DataGridTextColumn Header="Láº§n báº£o trÃ¬ cuá»‘i" Binding="{Binding LastMaintenanceDate, StringFormat=dd/MM/yyyy}" Width="120"/>
                    <DataGridTextColumn Header="NgÃ y táº¡o" Binding="{Binding CreatedDate, StringFormat=dd/MM/yyyy}" Width="100"/>
                </DataGrid.Columns>
            </DataGrid>
            
            <!-- Machine Details Panel -->
            <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto" Margin="10">
                <StackPanel>
                    <TextBlock Text="Chi tiáº¿t mÃ¡y" FontSize="18" FontWeight="Bold" Margin="0,0,0,20"/>
                    
                    <!-- Machine Info -->
                    <GroupBox Header="ThÃ´ng tin mÃ¡y" Margin="0,0,0,20">
                        <StackPanel Margin="10">
                            <TextBlock Text="{Binding SelectedMachine.MachineName, StringFormat='TÃªn: {0}'}" Margin="0,5"/>
                            <TextBlock Text="{Binding SelectedMachine.MachineType, StringFormat='Loáº¡i: {0}'}" Margin="0,5"/>
                            <TextBlock Text="{Binding SelectedMachine.Status, StringFormat='Tráº¡ng thÃ¡i: {0}'}" Margin="0,5"/>
                            <TextBlock Text="{Binding SelectedMachine.LastMaintenanceDate, StringFormat='Báº£o trÃ¬ cuá»‘i: {0:dd/MM/yyyy}'}" Margin="0,5"/>
                        </StackPanel>
                    </GroupBox>
                    
                    <!-- Current Order -->
                    <GroupBox Header="ÄÆ¡n hÃ ng hiá»‡n táº¡i" Margin="0,0,0,20">
                        <StackPanel Margin="10">
                            <TextBlock Text="KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o Ä‘ang cháº¡y" 
                                       Foreground="Gray" 
                                       TextWrapping="Wrap"
                                       Visibility="{Binding SelectedMachine.OrderMachines.Count, Converter={StaticResource CountToVisibilityConverter}}"/>
                            
                            <ItemsControl ItemsSource="{Binding SelectedMachine.OrderMachines}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="LightGray" BorderThickness="1" Margin="0,5" Padding="10">
                                            <StackPanel>
                                                <TextBlock Text="{Binding Order.OrderId, StringFormat='ÄÆ¡n hÃ ng: #{0}'}" FontWeight="Bold"/>
                                                <TextBlock Text="{Binding StartTime, StringFormat='Báº¯t Ä‘áº§u: {0:dd/MM/yyyy HH:mm}'}"/>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </GroupBox>
                    
                    <!-- Maintenance History -->
                    <GroupBox Header="Lá»‹ch sá»­ báº£o trÃ¬" Margin="0,0,0,20">
                        <StackPanel Margin="10">
                            <TextBlock Text="KhÃ´ng cÃ³ lá»‹ch sá»­ báº£o trÃ¬" 
                                       Foreground="Gray" 
                                       TextWrapping="Wrap"
                                       Visibility="{Binding SelectedMachine.MaintenanceHistory.Count, Converter={StaticResource CountToVisibilityConverter}}"/>
                            
                            <ItemsControl ItemsSource="{Binding SelectedMachine.MaintenanceHistory}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="LightGray" BorderThickness="1" Margin="0,5" Padding="10">
                                            <StackPanel>
                                                <TextBlock Text="{Binding MaintenanceDate, StringFormat='NgÃ y: {0:dd/MM/yyyy}'}" FontWeight="Bold"/>
                                                <TextBlock Text="{Binding Description}" TextWrapping="Wrap"/>
                                                <TextBlock Text="{Binding MaintenanceType, StringFormat='Loáº¡i: {0}'}" Foreground="Blue"/>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </GroupBox>
                </StackPanel>
            </ScrollViewer>
        </Grid>
        
        <!-- Status Bar -->
        <StatusBar Grid.Row="3" Background="#F0F0F0">
            <StatusBarItem>
                <TextBlock Text="{Binding Machines.Count, StringFormat='Tá»•ng sá»‘ mÃ¡y: {0}'}"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock Text="{Binding IsLoading, StringFormat='Äang táº£i: {0}'}"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</UserControl> 